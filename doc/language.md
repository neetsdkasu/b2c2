# BASIC言語について

--------------------------------------------------------------------------------

### 留意点

 - キーワードは大文字小文字が区別されない
 - 変数名・引数名は大文字小文字が区別される
 - プログラムエントリ名には小文字は使えない
 - 例外やエラーの機構は組み入れてない(一般的に例外やエラーが発生するような箇所も実行が継続する)
 - 1ファイルにつき1つのプログラムを記述する  
 - 要素アクセスや位置指定は0-based indexing


--------------------------------------------------------------------------------

### 基本構成

プログラムエントリ名の指定なし(プログラムエントリ名は*MAIN*になる)
```
[Option部]
[Extern Sub部]
[Argument部]
[Dim部]
[プログラム部]
```


プログラムエントリ名の指定あり
```
[Option部]
[Extern Sub部]
Sub プログラムエントリ名
    [Argument部]
    [Dim部]
    [プログラム部]
End Sub
```

|              |                                                                           |
|:-------------|:--------------------------------------------------------------------------|
| Option部     | CASL2ソースへの変換に関する指定をする場所                                 |
| Extern Sub部 | 外部定義のCASL2コードを呼び出すための宣言をする場所                       |
| Argument部   | 外部定義のCASL2コードから呼び出される場合に受け取る引数仕様を宣言する場所 |
| Dim部        | プログラムで使用する全ての変数を宣言する場所                              |
| プログラム部 | プログラムのメイン処理を書く場所                                          |

--------------------------------------------------------------------------------

### プログラムエントリ名

基本的にはCASL2のラベルの規則に従う (1～8文字、頭文字は英大文字、2文字目以降は英大文字か数字、GR1～GR7は不可)  

使用できないプログラムエントリ名(b2c2により使用される)
 - ALLOC
 - EOF
 - EXIT
 - MEM
 - 接頭が次のいずれかの文字列で以降に数字が続くもの
     + ARG
     + B
     + BA
     + C
     + F
     + I
     + IA
     + J
     + LB
     + LL
     + SB
     + SL
     + T
     + TB
     + TL
     + V

--------------------------------------------------------------------------------

### 型
 - 真理値
 - 符号付整数
 - 文字列 (符号付整数の可変長の配列としての使用も可能)
 - 真理値の固定長の配列
 - 符号付整数の固定長の配列


#### 真理値
リテラル:
 - `True`
 - `False`

内部表現:
 - 1語
 - `#FFFF`は`True`として解釈
 - `#0000`は`False`として解釈
 - それ以外の値の場合の真理値処理は未定義動作


#### 符号付整数
リテラル:
 - 10進表記 `-32768`～`32767`
 - 16進表記 `&H0000`～`&HFFFF` (`&H8000`～`&HFFFF`は負数として扱われる)
 - 文字リテラル(文字コード)
     + 1文字の図形文字または半角スペースを`"`と`"c`で囲む( 例: `"A"c` )
     + `"`の場合は`""""c`で記述


内部表現:
 - 1語
 - 2の補数表現(16ビット)


#### 文字列
符号付整数の可変長の配列としての使用も可能  

リテラル:
 - 0文字以上の図形文字と半角スペースの組み合わせを`"`で囲む
 - `"`を含む文字列の場合は`"`を`""`で記述
 - 文字列の最大長は256文字
 - Unicodeスカラー値(32ビット)を1文字として扱う

内部表現:
 - 長さ情報の格納に1語の領域が確保される
 - 文字の格納に256語の連続領域が確保される
 - 長さの領域の直後に文字の領域が続くよう確保される


#### 真理値の固定長の配列
リテラル:
 - なし

内部表現:
 - 宣言時に配列長を指定する(配列長の最小は1語、最大は256語)
 - 配列長分の連続領域が確保される
 - 各要素は真理値の定義に従う


#### 符号付整数の固定長の配列
リテラル:
 - なし

内部表現:
 - 宣言時に配列長を指定する(配列長の最小は1語、最大は256語)
 - 配列長分の連続領域が確保される
 - 各要素は符号付整数の定義に従う



--------------------------------------------------------------------------------

### キーワード(予約語?)一覧

| キーワード | 概要                                    | 分類      |
|:-----------|:----------------------------------------|:---------:|
| Abs        | 整数の絶対値を返す                      | 関数      |
| And        | 論理積を計算                            | 演算子    |
| Argument   | プログラムの引数を指定                  | 構文      |
| Array      | 一時的な固定長配列を生成                | 関数      |
| As         | 変数・引数の型指定に使用                | 構文      |
| Asc        | 文字列の先頭の値を返す                  | 関数      |
| Boolean    | 真理値の型名                            | 型        |
| ByRef      | 参照渡しの引数宣言に使用                | 構文      |
| ByVal      | 値渡しの引数宣言に使用                  | 構文      |
| CArray     | 固定長配列に変換                        | 関数      |
| CBool      | 真理値に変換                            | 関数      |
| CInt       | 整数に変換                              | 関数      |
| CStr       | 文字列に変換                            | 関数      |
| Call       | 外部プログラムの呼び出し                | 構文      |
| Case       | Selectの分岐の定義に使用                | 構文      |
| Chr        | 長さ1文字の文字列に変換                 | 関数      |
| Continue   | For/Doの続く処理をスキップする          | 構文      |
| Dim        | 変数の宣言                              | 構文      |
| Do         | 条件ループ処理の開始点                  | 構文      |
| Else       | 条件を満たさない分岐先として使用        | 構文      |
| ElseIf     | 条件分岐の1つとして使用                 | 構文      |
| End        | コードブロックの終了                    | 構文      |
| Eof        | 最後のInputがEOFだったかを返す          | 関数      |
| Exit       | コードブロックから脱出する              | 構文      |
| Extern     | 外部プログラムの宣言                    | 構文      |
| False      | 真理値のリテラル                        | 値        |
| Fill       | 配列を指定の値で埋める                  | 構文      |
| For        | カウンタループの開始点                  | 構文      |
| From       | 引数に対応するレジスタの指定に使用      | 構文      |
| If         | 条件分岐の最初の条件                    | 構文      |
| Input      | ユーザ入力を受け取る                    | 構文      |
| Integer    | 整数の型名                              | 型        |
| Len        | 文字列や配列の長さを返す                | 関数      |
| Loop       | Doループのブロック終端に使用            | 構文      |
| Max        | 2つの整数のうちの最大値を返す           | 関数      |
| Mid        | 部分文字列の取得や更新                  | 構文/関数 |
| Min        | 2つの整数のうち最小値を返す             | 関数      |
| Mod        | 余りを計算する             | 演算子    |
| Next       | Forループのブロック終端に使用           | 構文      |
| Not        | 論理否定を計算                          | 演算子    |
| Option     | CASL2ソース変換に関する指定             | 構文      |
| Or         | 論理和を計算                            | 演算子    |
| Print      | 値や文字列を画面に出力                  | 構文      |
| Rem        | コメント行                              | 構文      |
| Select     | 値や文字列分岐処理の開始点              | 構文      |
| Space      | 半角スペースの文字列を返す              | 関数      |
| Step       | Forループのカウンタの変化量指定に使用   | 構文      |
| String     | 文字列の型名、文字列の生成              | 型/関数   |
| Sub        | プログラムエントリ名の指定に使用        | 構文      |
| SubArray   | 部分配列を取得                          | 関数      |
| Then       | If文における飾り                        | 構文      |
| To         | Forループの終了値などに使用             | 構文      |
| True       | 真理値のリテラル                        | 値        |
| Until      | Doループの条件指定に使用、Trueなら終了  | 構文      |
| While      | Doループの条件指定に使用、Trueなら継続  | 構文      |
| With       | 外部プログラム宣言の引数記述に使用      | 構文      |
| Xor        | 排他的論理和を計算                      | 演算子    |


--------------------------------------------------------------------------------

### 演算子

| 順位 | 演算子 | 概要                                                    | 種類       | 対象          |
|-----:|:------:|:--------------------------------------------------------|:----------:|:-------------:|
|    1 | `-`    | 整数の符号反転(※5)                                     | 単項演算子 | 整数          |
|    1 | `Not`  | 整数のビット反転                                        | 単項演算子 | 整数          |
|    1 | `Not`  | 真理値の論理否定                                        | 単項演算子 | 真理値        |
|    2 | `>>`   | 算術右シフト (SRAを実行)                                | 二項演算子 | 整数          |
|    2 | `<<`   | 算術左シフト (SLAを実行)                                | 二項演算子 | 整数          |
|    2 | `>>>`  | 論理右シフト (SRLを実行)                                | 二項演算子 | 整数          |
|    2 | `<<<`  | 論理左シフト (SLLを実行)                                | 二項演算子 | 整数          |
|    3 | `*`    | 2つの整数の積。掛け算                                   | 二項演算子 | 整数          |
|    3 | `\`    | 2つの整数の商。割り算 (※6)                             | 二項演算子 | 整数          |
|    3 | `Mod`  | 2つの整数の剰余。剰余演算 (※6)                         | 二項演算子 | 整数          |
|    4 | `+`    | 2つの整数の和。足し算                                   | 二項演算子 | 整数          |
|    4 | `-`    | 2つの整数の差。引き算                                   | 二項演算子 | 整数          |
|    4 | `&`    | 2つの文字列を結合                                       | 二項演算子 | 文字列        |
|    5 | `<`    | 2つの整数で左辺値が小さい場合に`True`                   | 二項演算子 | 整数          |
|    5 | `>`    | 2つの整数で右辺値が小さい場合に`True`                   | 二項演算子 | 整数          |
|    5 | `>=`   | 2つの整数で左辺値が小さい場合に`False`                  | 二項演算子 | 整数          |
|    5 | `<=`   | 2つの整数で右辺値が小さい場合に`False`                  | 二項演算子 | 整数          |
|    5 | `<`    | 2つの整数配列で左辺が辞書順で小さい場合に`True` (※7)   | 二項演算子 | 整数配列(※3) |
|    5 | `>`    | 2つの整数配列で右辺が辞書順で小さい場合に`True` (※7)   | 二項演算子 | 整数配列(※3) |
|    5 | `>=`   | 2つの整数配列で左辺が辞書順で小さい場合に`False` (※7)  | 二項演算子 | 整数配列(※3) |
|    5 | `<=`   | 2つの整数配列で右辺が辞書順で小さい場合に`False` (※7)  | 二項演算子 | 整数配列(※3) |
|    6 | `=`    | 2つのデータが一致する場合に`True`                       | 二項演算子 | 全ての型      |
|    6 | `<>`   | 2つのデータが一致しない場合に`True`                     | 二項演算子 | 全ての型      |
|    7 | `And`  | 2つの整数のビット論理積                                 | 二項演算子 | 整数          |
|    7 | `Or`   | 2つの整数のビット論理和                                 | 二項演算子 | 整数          |
|    7 | `Xor`  | 2つの整数のビット排他的論理和                           | 二項演算子 | 整数          |
|    7 | `And`  | 2つの真理値の論理積                                     | 二項演算子 | 真理値        |
|    7 | `Or`   | 2つの真理値の論理和                                     | 二項演算子 | 真理値        |
|    7 | `Xor`  | 2つの真理値の排他的論理和                               | 二項演算子 | 真理値        |
|    8 | `,`    | パラメータの区切りに使用される                          | 二項演算子 | 全ての型      |

 - ※1 ... 二項演算子は全て左結合
 - ※2 ... `,`以外の二項演算子は同一の型同士にのみ使用できる
 - ※3 ... 整数配列とは文字列と符号付整数の固定長配列の2つを指す
 - ※4 ... オーバーフローは検知せず無視する
 - ※5 ... `-32768`は符号反転せず`-32768`のままになる
 - ※6 ... 0で除算してもエラーにはならず、計算結果は不定
 - ※7 ... 辞書順は配列の先頭から順に1語ごとの整数比較を行い最初の違いを辞書順の比較結果とする

--------------------------------------------------------------------------------

### コメント行(Rem)

`Rem`または`'`から始まる行はコメント行となる  
コメントにはUTF-8の有効な文字を使用する  
コメントは無視されるためプログラムの変換に影響を与えることはない  


例:
```vb
Rem これはコメント
' これもコメント
Dim i As Integer
For i = 0 To 5
    Rem ここもコメント
    ' これもコメント
Next i
```

有効なステートメントの末尾で`'`から始まる行の残り部分がコメントになる  
例:
```vb
Dim i As Integer      ' コメント
For i = 0 To 5        ' コメント
    Print i           ' コメント
Next i                ' コメント
```


--------------------------------------------------------------------------------

### 変数宣言(Dim)
変数を使用する場合は宣言する必要がある  
Dim文1つにつき1つの変数を宣言できる   
変数名は
 - 1文字以上、30文字以下
 - 頭文字は大文字か小文字の英字
 - 2文字目以降は大文字か小文字の英字か数字かアンダースコア
 - 文字は全て半角(ASCII範囲)
 - 英字の大文字小文字は区別される
 - プログラム内でユニークになるように命名する必要がある
 - キーワード(予約語)に一致する名前は使用できない
 - Argument部の引数名に一致する名前は使用できない

| 型                     | 書式                            |
|:-----------------------|:--------------------------------|
| 真理値                 | `Dim 変数名 As Boolean`         |
| 符号付整数             | `Dim 変数名 As Integer`         |
| 文字列                 | `Dim 変数名 As String`          |
| 真理値の固定長配列     | `Dim 変数名(上界値) As Boolean` |
| 符号付整数の固定長配列 | `Dim 変数名(上界値) As Integer` |

※上界値 ... 配列長におけるインデックスの最大値 (つまり`配列長-1`)  
※配列長は1～256 (つまり上界値は0～255)  
  
  


例:
```vb
Dim myFlag As Boolean
Dim Value123 As Integer
Dim foo_bar As String
Dim flags(9) As Boolean
Dim my_array(255) As Integer
```

変数のメモリ領域について:  
 - 真理値、整数、文字列、真理値固定長配列、整数固定長配列の順で連続した領域に確保される(型ごとの順序は宣言順になる)  


--------------------------------------------------------------------------------

### 式

リテラル、変数、関数、演算子、演算順序を決める括弧`( )`による組み合わせで構成される  
  
例: (※`abc`,`efg`は整数変数とする)  
 - 結果が整数の式: `123 + (345 * 10) - 5`
 - 結果が整数の式: `(abc + 4) * Max(1, efg)`
 - 結果が真理値の式: `(abc = 123) Or (efg <> 123)`
 - 結果が文字列の式: `"ABC" & CStr(abc + 5) & "EFG"`


--------------------------------------------------------------------------------

### 変数への代入

`変数名 = 式`で変数に値を代入できる   

例:
```vb
Dim intValue As Integer
Dim blnValue As Boolean
Dim strValue As String
Dim intArray(4) As Integer
Dim blnArray(4) As Boolean

intValue = 1234
intValue = 5 - 3 * 2
blnValue = True
strValue = "ABC" & "EFG"
intArray = Array(1, 2, 3, 4, 5)
blnArray = Array(True, False, False, True, True)
```

--------------------------------------------------------------------------------

### 要素アクセス(文字列、配列)

`変数名(インデックス)`で配列・文字列の要素にアクセスできる  
インデックスが範囲外を示すとき範囲内に収まるように丸められる(負数なら0、配列長以上なら上界値)  
長さ0の文字列の要素にアクセスした場合はエラーにならず何らかの値が返る  
長さデータの壊れた文字列に対する要素アクセスの結果は未定義  

例:
```vb
Dim i As Integer
Dim iArr(5) As Integer
Dim bArr(5) As Boolean
Dim str1 As String
str1 = "ABCDEF"
For i = 0 To 5
    ' 値取得
    Print iArr(i)
    Print bArr(i)
    Print str1(i)
    ' 代入
    iArr(i) = 123
    bArr(i) = True
    str1(i) = "a"c
Next i
```

  
特別なケースとして文字列リテラルに対しても要素アクセスが可能(値取得のみ)  
例:
```vb
Dim i  As Integer
Dim ch As Integer
For i = 0 To 5
    ch = "ABCDEF"(i)
    Print Chr(ch)
Next i
```

